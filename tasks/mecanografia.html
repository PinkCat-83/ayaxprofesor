<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../favicon.ico">
    <title>Mecanograf√≠a AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            overflow: hidden;
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transition: opacity 0.3s ease;

        }

        #bg-canvas.hidden {
            opacity: 0;
        }

        .app-container {
            position: relative;
            z-index: 10;
            max-width: 1000px;
            margin: 5vh auto;
            padding: 2rem;
            border: 3px solid transparent;
            border-radius: 1.5rem;
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.5);
            backdrop-filter: blur(8px);
            background-color: rgba(0, 0, 0, 0.7);
            transition: box-shadow 0.3s ease;
        }

        #target-text {
            min-height: 150px;
            max-height: 400px;
            height: 400px;
            overflow: auto;
            padding: 1rem;
            font-size: 1.25rem;
            line-height: 1.6;
            letter-spacing: 0.05em;
            border-radius: 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid #ff007f;
            box-shadow: 0 0 10px rgba(255, 0, 127, 0.5);
            color: #fff;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            position: relative;
            transition: opacity 0.3s ease;
        }

        #target-text::-webkit-scrollbar {
            width: 8px;
        }

        #target-text::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        #target-text::-webkit-scrollbar-thumb {
            background: #ff007f;
            border-radius: 4px;
        }

        #user-input {
            width: 100%;
            height: 100px;
            padding: 1rem;
            font-size: 1.25rem;
            line-height: 1.6;
            margin-top: 1rem;
            border-radius: 0.75rem;
            background-color: #111;
            border: 2px solid #ff007f;
            box-shadow: 0 0 10px rgba(255, 0, 127, 0.5);
            color: #fff;
            resize: none;
            caret-color: #00ffff;
        }

        .correct {
            color: #4ade80;
        }

        .incorrect {
            color: #f87171;
            text-decoration: underline;
        }

        .current {
            background-color: rgba(0, 255, 255, 0.3);
            border-bottom: 2px solid #00ffff;
            position: relative;
        }

        span[data-char="newline"] {
            display: inline-block;
            background-color: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #00ffff;
            padding: 0 0.5rem;
            margin-right: 0.5rem;
        }

        span[data-char="newline"].current::after {
            content: " Presiona Enter";
            padding: 0.25rem 0.75rem;
            background-color: rgba(0, 255, 255, 0.9);
            color: #000;
            font-size: 0.875rem;
            font-weight: bold;
            border-radius: 0.25rem;
            animation: pulse 1s ease-in-out infinite;
            margin-left: 0.5rem;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
                background-color: rgba(248, 113, 113, 0.5);
            }

            75% {
                transform: translateX(5px);
                background-color: rgba(248, 113, 113, 0.5);
            }
        }

        .shake-error {
            animation: shake 0.2s ease-in-out;
            border-bottom: 2px solid #f87171 !important;
        }

        .neon-button {
            background-color: #ff007f;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            text-shadow: 0 0 5px #ff007f;
            box-shadow: 0 0 10px #ff007f, 0 0 20px rgba(255, 0, 127, 0.5);
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }

        .neon-button:hover {
            background-color: #ff3399;
            box-shadow: 0 0 15px #ff3399, 0 0 30px #ff3399;
            transform: translateY(-2px);
        }

        .neon-button.small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .neon-button.selected {
            background-color: #00ffff;
            color: #000;
            text-shadow: none;
            box-shadow: 0 0 10px #00ffff, 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff007f;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .metric-label {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
            display: block;
        }

        .control-panel {
            position: fixed;
            top: 6rem;
            left: 1.5rem;
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff007f;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 0 15px rgba(255, 0, 127, 0.5);
            min-width: 240px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 1.5rem;
        }

        .control-title {
            font-size: 0.875rem;
            color: #ff007f;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: #ff007f;
            box-shadow: 0 0 10px rgba(255, 0, 127, 0.5);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(26px);
        }

        .paragraph-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .paragraph-buttons button {
            flex: 1;
        }

        /* Distractores */
        .particle {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
            opacity: 0.6;
        }

        .wave-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        .wave-overlay.active {
            display: block;
        }

        .emoji-rain {
            position: fixed;
            font-size: 8rem;
            pointer-events: none;
            z-index: 100;
            opacity: 0.7;
        }

        .rain-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: none;
            background: linear-gradient(transparent 0%, rgba(100, 150, 200, 0.1) 100%);
        }

        .rain-overlay.active {
            display: block;
        }

        .raindrop {
            position: fixed;
            width: 5px;
            height: 100px;
            background: linear-gradient(to bottom, transparent, rgba(174, 194, 224, 0.9));
            pointer-events: none;
            z-index: 100;

        }

        .thunder-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 100, 0.7);
            pointer-events: none;
            z-index: 150;
            display: none;
        }

        .thunder-flash.active {
            display: block;
            animation: flash 0.3s ease-out;
        }

        @keyframes flash {

            0%,
            100% {
                opacity: 0;
            }

            50% {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-black text-white">

    <canvas id="bg-canvas" class="hidden"></canvas>
    <canvas id="wave-canvas" class="wave-overlay"></canvas>
    <div id="rain-overlay" class="rain-overlay"></div>
    <div id="thunder-flash" class="thunder-flash"></div>

    <button id="reset-button" class="neon-button fixed top-6 left-6 z-50 text-sm">
        ‚Üª Nuevo Texto
    </button>

    <div class="control-panel">
        <div class="control-section">
            <div class="control-title">Fuente de Texto</div>
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                Wiki
                <label class="toggle-switch">
                    <input type="checkbox" id="source-toggle">
                    <span class="toggle-slider"></span>
                </label>
                <span id="source-label" style="font-size: 0.875rem; color: #fff;">IA (Gratis)</span>
            </div>
            <p class="text-[10px] text-gray-400 mt-1">Usa Pollinations AI</p>
        </div>

        <div class="control-section">
            <div class="control-title">P√°rrafos</div>
            <div class="paragraph-buttons">
                <button class="neon-button small selected" data-paragraphs="1">1</button>
                <button class="neon-button small" data-paragraphs="2">2</button>
                <button class="neon-button small" data-paragraphs="3">3</button>
            </div>
        </div>

        <div class="control-section">
            <div class="control-title">Distractores</div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                <label class="toggle-switch">
                    <input type="checkbox" id="distractor2-toggle">
                    <span class="toggle-slider"></span>
                </label>
                <span id="distractor2-label" style="font-size: 0.875rem; color: #fff;">üéâ Part√≠culas</span>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                <label class="toggle-switch">
                    <input type="checkbox" id="distractor3-toggle">
                    <span class="toggle-slider"></span>
                </label>
                <span id="distractor3-label" style="font-size: 0.875rem; color: #fff;">üìª Onda</span>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem;">
                <label class="toggle-switch">
                    <input type="checkbox" id="distractor4-toggle">
                    <span class="toggle-slider"></span>
                </label>
                <span id="distractor4-label" style="font-size: 0.875rem; color: #fff;">üê± Animales</span>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem;">
                <label class="toggle-switch">
                    <input type="checkbox" id="stars-toggle">
                    <span class="toggle-slider"></span>
                </label>
                <span id="distractor1-label" style="font-size: 0.875rem; color: #fff;"> üåü Estrellas</span>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem;">
                <label class="toggle-switch">
                    <input type="checkbox" id="distractor5-toggle">
                    <span class="toggle-slider"></span>
                </label>
                <span id="distractor5-label" style="font-size: 0.875rem; color: #fff;">‚ö° Tormenta</span>
            </div>

        </div>
    </div>
    </div>

    <div class="app-container">
        <h1 class="text-4xl font-bold text-center mb-6 text-white" style="text-shadow: 0 0 10px #ff007f;">Mecanograf√≠a
            AI</h1>

        <div
            class="grid grid-cols-2 md:grid-cols-5 gap-4 text-lg mb-4 p-3 border border-gray-700 rounded-lg bg-black/50">
            <div class="text-center">
                <span class="metric-label">WPM</span>
                <p id="wpm" class="text-2xl font-mono text-teal-400" style="text-shadow: 0 0 5px #00ffff;">0</p>
            </div>
            <div class="text-center">
                <span class="metric-label">PPM</span>
                <p id="cpm" class="text-2xl font-mono text-purple-400" style="text-shadow: 0 0 5px #a855f7;">0</p>
            </div>
            <div class="text-center">
                <span class="metric-label">Errores</span>
                <p id="errors" class="text-2xl font-mono text-red-400" style="text-shadow: 0 0 5px #f87171;">0</p>
            </div>
            <div class="text-center">
                <span class="metric-label">% Errores</span>
                <p id="error-percent" class="text-2xl font-mono text-orange-400" style="text-shadow: 0 0 5px #fb923c;">
                    0%</p>
            </div>
            <div class="text-center col-span-2 md:col-span-1">
                <span class="metric-label">Tiempo (s)</span>
                <p id="timer" class="text-2xl font-mono text-yellow-400" style="text-shadow: 0 0 5px #facc15;">0</p>
            </div>
        </div>

        <div id="target-text" class="mb-4">
            <div class="flex justify-center items-center h-full">
                <div class="loader"></div>
                <span class="ml-4 text-xl">Iniciando...</span>
            </div>
        </div>

        <textarea id="user-input" placeholder="Empieza a escribir aqu√≠..." spellcheck="false" autofocus
            class="focus:outline-none focus:border-cyan-400 focus:ring-4 focus:ring-cyan-400/50"></textarea>
    </div>

    <script>
        // Elementos del DOM
        const targetTextElement = document.getElementById('target-text');
        const userInputElement = document.getElementById('user-input');
        const wpmElement = document.getElementById('wpm');
        const cpmElement = document.getElementById('cpm');
        const errorsElement = document.getElementById('errors');
        const errorPercentElement = document.getElementById('error-percent');
        const timerElement = document.getElementById('timer');
        const resetButton = document.getElementById('reset-button');
        const starsToggle = document.getElementById('stars-toggle');
        const starsLabel = document.getElementById('distractor1-label');
        const sourceToggle = document.getElementById('source-toggle');
        const sourceLabel = document.getElementById('source-label');
        const bgCanvas = document.getElementById('bg-canvas');
        const paragraphButtons = document.querySelectorAll('[data-paragraphs]');
        const waveCanvas = document.getElementById('wave-canvas');
        const distractor2Toggle = document.getElementById('distractor2-toggle');
        const distractor3Toggle = document.getElementById('distractor3-toggle');
        const distractor4Toggle = document.getElementById('distractor4-toggle');
        const distractor5Toggle = document.getElementById('distractor5-toggle');
        const rainOverlay = document.getElementById('rain-overlay');
        const thunderFlash = document.getElementById('thunder-flash');

        // Estado
        let targetText = "";
        let allParagraphs = [];
        let currentParagraphIndex = 0;
        let isTyping = false;
        let isFinished = false; // Estado para controlar el final
        let startTime = null;
        let timerInterval = null;
        let totalErrors = 0;
        let selectedParagraphs = 1;
        let useAI = false;
        let isAutoTyping = false; // Estado para auto-escritura
        let autoTypeInterval = null;

        // Distractores
        let particlesEnabled = false;
        let particles = [];
        let waveEnabled = false;
        let waveCtx = null;
        let waveOffset = 0;
        let waveY = 0;
        let waveDirection = 1;
        let emojiRainEnabled = false;
        let emojiInterval = null;
        let stormEnabled = false;
        let raindrops = [];
        let rainInterval = null;
        let thunderInterval = null;

        // Three.js
        let scene, camera, renderer, stars;
        let rotationSpeed = 0.0005;
        const maxSpeed = 0.02;
        let starsEnabled = false;

        // ---------------------------------------------------------
        // UTILIDADES
        // ---------------------------------------------------------
        function normalizeText(text) {
            return text
                .replace(/==/g, '')
                .replace(/[¬´¬ª]/g, '"')
                .replace(/[\u2018\u2019]/g, "'")
                .replace(/[\u201C\u201D]/g, '"')
                .replace(/[\u2013\u2014]/g, '-')
                .replace(/\[.*?\]/g, '')
                .replace(/[\u200B-\u200D\uFEFF\t]/g, '')
                // Eliminar s√≠mbolos de ordinal (¬∫ ¬™)
                .replace(/[¬∫¬™]/g, '')
                // Convertir super√≠ndices a n√∫meros normales
                .replace(/[‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ]/g, (match) => {
                    const superscripts = '‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ';
                    return '0123456789'[superscripts.indexOf(match)];
                })
                // Convertir sub√≠ndices a n√∫meros normales
                .replace(/[‚ÇÄ‚ÇÅ‚ÇÇ‚ÇÉ‚ÇÑ‚ÇÖ‚ÇÜ‚Çá‚Çà‚Çâ]/g, (match) => {
                    const subscripts = '‚ÇÄ‚ÇÅ‚ÇÇ‚ÇÉ‚ÇÑ‚ÇÖ‚ÇÜ‚Çá‚Çà‚Çâ';
                    return '0123456789'[subscripts.indexOf(match)];
                })
                // Eliminar espacios antes de saltos de l√≠nea
                .replace(/ +\n/g, '\n')
                .trim();
        }

        // ---------------------------------------------------------
        // IA (Pollinations.ai)
        // ---------------------------------------------------------
        async function fetchAIGeneratedText() {
            targetTextElement.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div><span class="ml-4 text-xl">IA Creando historia...</span></div>`;
            userInputElement.disabled = true;

            // Temas aleatorios para mayor variedad
            const temas = [
                "una aventura espacial", "un viaje en el tiempo", "una historia de misterio",
                "una expedici√≥n submarina", "la vida en una ciudad futurista",
                "un encuentro con criaturas m√≠ticas", "una jornada en la selva",
                "la historia de un inventor", "un d√≠a en la vida de un chef",
                "una competencia deportiva √©pica", "un descubrimiento arqueol√≥gico",
                "la vida de un m√∫sico callejero", "una misi√≥n de rescate",
                "un experimento cient√≠fico que sale mal", "una historia de amistad",
                "las aventuras de un gato rosa m√°gico", "las vivencias de un gato rosa con el Excel",
                "una historia sobre un pl√°tano que repet√≠a todo tres veces", "un viaje al supermercado"
            ];

            const temaAleatorio = temas[Math.floor(Math.random() * temas.length)];
            const timestamp = Date.now(); // A√±ade un elemento √∫nico
            const seed = Math.random().toString(36).substring(7); // Seed aleatorio

            const prompt = `Escribe ${selectedParagraphs} p√°rrafo(s) sobre ${temaAleatorio}. Cada p√°rrafo debe tener aproximadamente 100 palabras. Crea una narrativa √∫nica e interesante. ID: ${seed}-${timestamp}. IMPORTANTE: Devuelve SOLO el texto de la historia, sin t√≠tulos ni introducciones.`;
            const url = `https://text.pollinations.ai/${encodeURIComponent(prompt)}?model=openai&seed=${seed}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Error en servidor");
                let text = await response.text();
                text = normalizeText(text);

                allParagraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
                if (allParagraphs.length === 0) allParagraphs = [text];
                if (allParagraphs.length > selectedParagraphs) allParagraphs = allParagraphs.slice(0, selectedParagraphs);

                initGame(allParagraphs);
            } catch (error) {
                console.error(error);
                fetchRandomWikipediaText(); // Fallback
            }
        }

        // ---------------------------------------------------------
        // WIKIPEDIA
        // ---------------------------------------------------------
        async function fetchRandomWikipediaText(attempts = 0) {
            targetTextElement.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div><span class="ml-4 text-xl">Buscando Wiki...</span></div>`;
            userInputElement.disabled = true;

            try {
                const r1 = await fetch(`https://es.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*&_=${Date.now()}`);
                const d1 = await r1.json();
                const title = d1.query.random[0].title;
                const r2 = await fetch(`https://es.wikipedia.org/w/api.php?action=query&prop=extracts&explaintext=1&titles=${encodeURIComponent(title)}&format=json&origin=*`);
                const d2 = await r2.json();
                const page = Object.values(d2.query.pages)[0];
                let raw = normalizeText(page.extract || "");

                // Procesar frases
                let sentences = raw.match(/[^.!?]+[.!?]+/g) || [];
                let paras = [];
                let chunk = "";
                let count = 0;
                for (let s of sentences) {
                    if (s.length < 20) continue;
                    chunk += s.trim() + " ";
                    count++;
                    if (count >= 5) {
                        paras.push(chunk.trim());
                        chunk = ""; count = 0;
                        if (paras.length >= selectedParagraphs) break;
                    }
                }

                if (paras.length < selectedParagraphs) {
                    if (attempts < 5) return fetchRandomWikipediaText(attempts + 1);
                    paras = ["La mecanograf√≠a es el arte de escribir a m√°quina."];
                }
                initGame(paras);

            } catch (e) {
                console.error(e);
                initGame(["Error de conexi√≥n. Intenta recargar."]);
            }
        }

        function initGame(paragraphs) {
            allParagraphs = paragraphs;
            currentParagraphIndex = 0;
            targetText = allParagraphs[0];
            resetAppState();
            renderTargetText(targetText);
            userInputElement.disabled = false;
            userInputElement.focus();
        }

        function fetchText() {
            if (useAI) fetchAIGeneratedText();
            else fetchRandomWikipediaText(0);
        }

        // ---------------------------------------------------------
        // L√ìGICA DE JUEGO
        // ---------------------------------------------------------
        function renderTargetText(text) {
            let html = '';
            text.split('').forEach((char, index) => {
                const isCurrent = index === 0 ? 'current' : '';
                const display = char === '\n' ? '‚Üµ' : char;
                const br = char === '\n' ? '<br>' : '';
                const dataAttr = char === '\n' ? 'data-char="newline"' : '';
                html += `<span id="char-${index}" class="${isCurrent}" ${dataAttr}>${display}</span>${br}`;
            });
            targetTextElement.innerHTML = html;
        }

        function generateTestText() {
            const testParagraphs = [
                "Texto de prueba con super√≠ndices: X¬≤ Y¬≥ Z‚Å¥ y n√∫meros 2 3 4 normales.",
                "Texto con sub√≠ndices: H‚ÇÇO CO‚ÇÇ y tambi√©n H2O CO2 normales.",
                "Texto con ordinales: 1¬∫ lugar, 2¬™ posici√≥n, 3¬∫ puesto deber√≠an verse como 1 2 3.",
                "Prueba de espacios antes de salto:    \nEsta l√≠nea deber√≠a empezar sin espacios previos.",
                "Combinaci√≥n completa: N¬∫ 5, f√≥rmula H‚ÇÇSO‚Å¥ y resultado X¬≤ = 16. ¬°Perfecto!"
            ];

            // Normalizar cada p√°rrafo
            const normalizedParagraphs = testParagraphs.map(p => normalizeText(p));

            targetTextElement.innerHTML = `<div class="flex justify-center items-center h-full"><p class="text-center text-xl" style="color: #00ffff;">üß™ Modo Prueba Activado üß™</p></div>`;

            setTimeout(() => {
                initGame(normalizedParagraphs);
            }, 500);
        }

        function startAutoTyping() {
            // Detener si ya est√° en modo auto
            if (isAutoTyping) {
                stopAutoTyping();
                return;
            }

            // Solicitar velocidad al usuario (WPM)
            const wpmInput = prompt("¬øA qu√© velocidad quieres que escriba?\n\nIntroduce WPM (Palabras Por Minuto):\n\nSugerencias:\n‚Ä¢ 40 WPM = Principiante\n‚Ä¢ 60 WPM = Intermedio\n‚Ä¢ 80 WPM = Avanzado\n‚Ä¢ 100+ WPM = Experto", "60");

            if (wpmInput === null) return; // Usuario cancel√≥

            const wpm = parseInt(wpmInput);

            if (isNaN(wpm) || wpm <= 0 || wpm > 200) {
                alert("Por favor, introduce un n√∫mero v√°lido entre 1 y 200 WPM.");
                return;
            }

            // Calcular delay entre caracteres
            // WPM = (caracteres/5) / minutos
            // caracteres por minuto = WPM * 5
            // milisegundos por car√°cter = 60000 / (WPM * 5)
            const delayMs = Math.round(60000 / (wpm * 5));

            isAutoTyping = true;
            userInputElement.disabled = true;

            let currentCharIndex = 0;

            autoTypeInterval = setInterval(() => {
                if (currentCharIndex >= targetText.length || !isAutoTyping) {
                    stopAutoTyping();
                    return;
                }

                const char = targetText[currentCharIndex];
                userInputElement.value += char;

                // Simular evento de input
                const event = new Event('input', { bubbles: true });
                event.inputType = 'insertText';
                userInputElement.dispatchEvent(event);

                currentCharIndex++;
            }, delayMs);

            // Mostrar notificaci√≥n
            targetTextElement.style.boxShadow = "0 0 20px rgba(0, 255, 255, 0.8)";
            setTimeout(() => {
                targetTextElement.style.boxShadow = "";
            }, 1000);
        }

        function stopAutoTyping() {
            isAutoTyping = false;
            if (autoTypeInterval) {
                clearInterval(autoTypeInterval);
                autoTypeInterval = null;
            }
            if (!isFinished) {
                userInputElement.disabled = false;
                userInputElement.focus();
            }
        }

        function resetAppState() {
            userInputElement.value = '';
            targetTextElement.scrollTop = 0;
            isFinished = false; // Resetear estado final

            // Solo reseteamos contadores si es el primer p√°rrafo
            if (currentParagraphIndex === 0) {
                totalErrors = 0;
                isTyping = false;
                startTime = null;
                clearInterval(timerInterval);
                timerInterval = null;
                wpmElement.textContent = 0;
                cpmElement.textContent = 0;
                errorsElement.textContent = 0;
                errorPercentElement.textContent = "0%";
                timerElement.textContent = 0;
                rotationSpeed = 0.0005;
            }
            // Si no es el primer p√°rrafo, el timer debe seguir corriendo
            // No reseteamos startTime ni el interval
        }

        function handleInput(e) {
            // SI EL JUEGO HA TERMINADO:
            if (isFinished) return;

            let typedText = userInputElement.value;
            if (targetText.length === 0) return;

            // Iniciar timer
            if (typedText.length > 0 && !isTyping) {
                isTyping = true;
                startTime = new Date().getTime();
                timerInterval = setInterval(updateMetrics, 1000);
            }

            // Borrar
            if (e.inputType === 'deleteContentBackward') {
                const pos = typedText.length;
                const curr = document.getElementById(`char-${pos}`);
                const next = document.getElementById(`char-${pos + 1}`);
                if (curr) curr.className = 'current';
                if (next) next.className = '';
                return;
            }

            const currentPosition = typedText.length - 1;
            const targetChar = targetText[currentPosition];
            const typedChar = typedText[currentPosition];

            // Bloquear Enter incorrecto
            if (targetChar === '\n' && typedChar !== '\n') {
                const el = document.getElementById(`char-${currentPosition}`);
                if (el) shakeElement(el);
                userInputElement.value = typedText.slice(0, -1);
                return;
            }

            const charElement = document.getElementById(`char-${currentPosition}`);

            // Error
            if (typedChar !== targetChar) {
                if (charElement && !charElement.dataset.errorLogged) {
                    totalErrors++;
                    charElement.dataset.errorLogged = 'true';
                }
                if (charElement) shakeElement(charElement);
                userInputElement.value = typedText.slice(0, -1);
                updateMetrics();
                return;
            }

            // Correcto
            if (charElement) charElement.className = 'correct';
            const nextChar = document.getElementById(`char-${currentPosition + 1}`);
            if (nextChar) nextChar.classList.add('current');

            // Fin de p√°rrafo
            if (typedText.length === targetText.length) {
                if (currentParagraphIndex < allParagraphs.length - 1) {
                    // Siguiente P√°rrafo
                    currentParagraphIndex++;
                    targetText = allParagraphs[currentParagraphIndex];
                    targetTextElement.style.opacity = '0';
                    setTimeout(() => {
                        resetAppState(); // Limpia input
                        renderTargetText(targetText);
                        targetTextElement.style.opacity = '1';
                        userInputElement.focus();
                    }, 300);
                } else {
                    // FIN DEL JUEGO
                    finishTest();
                }
            }
            updateMetrics();
        }

        function shakeElement(el) {
            el.classList.remove('current');
            el.classList.add('shake-error');
            setTimeout(() => { el.classList.remove('shake-error'); el.classList.add('current'); }, 200);
        }

        function updateMetrics() {
            if (!startTime) return;
            const elapsed = Math.floor((new Date().getTime() - startTime) / 1000);
            timerElement.textContent = elapsed;

            // Contar caracteres correctos en TODOS los p√°rrafos completados + el actual
            let totalCorrectChars = 0;

            // Sumar caracteres de p√°rrafos anteriores completados
            for (let i = 0; i < currentParagraphIndex; i++) {
                totalCorrectChars += allParagraphs[i].length;
            }

            // Sumar caracteres correctos del p√°rrafo actual
            totalCorrectChars += document.querySelectorAll('#target-text .correct').length;

            if (elapsed > 0) {
                wpmElement.textContent = Math.round((totalCorrectChars / 5) / (elapsed / 60));
                cpmElement.textContent = Math.round(totalCorrectChars / (elapsed / 60));
            }
            errorsElement.textContent = totalErrors;

            // Error % considerando todos los caracteres escritos
            let totalTyped = userInputElement.value.length + totalErrors;
            // Sumar tambi√©n los caracteres de p√°rrafos anteriores
            for (let i = 0; i < currentParagraphIndex; i++) {
                totalTyped += allParagraphs[i].length;
            }

            if (totalTyped > 0) {
                errorPercentElement.textContent = ((totalErrors / totalTyped) * 100).toFixed(1) + "%";
            }

            // Velocidad estrellas
            const wpm = parseInt(wpmElement.textContent) || 0;
            const ratio = Math.min(1, wpm / 80);
            rotationSpeed = 0.0005 + ratio * (maxSpeed - 0.0005);
        }

        function finishTest() {
            clearInterval(timerInterval);
            isTyping = false;
            userInputElement.disabled = true;

            const finalWPM = wpmElement.textContent;
            const finalCPM = cpmElement.textContent;
            const finalErrors = errorsElement.textContent;
            const finalErrorPercent = errorPercentElement.textContent;

            const message = `¬°PRUEBA COMPLETADA!\n\nPalabras por Minuto: ${finalWPM}\nPulsaciones por Minuto: ${finalCPM}\nErrores: ${finalErrors} (${finalErrorPercent})`;

            targetTextElement.innerHTML = `<div class="flex justify-center items-center h-full"><p class="text-center font-bold text-2xl p-4 leading-loose" style="color: #00ffff;">${message.replace(/\n/g, '<br>')}</p></div>`;
            userInputElement.disabled = false;
        }

        // Listener global para reiniciar con Enter si ha terminado
        userInputElement.addEventListener('keydown', (e) => {
            if (isFinished && e.key === 'Enter') {
                e.preventDefault();
                fetchText();
            }

            // Ctrl + √ë para generar texto de prueba con excepciones
            if (e.ctrlKey && !e.shiftKey && e.key === '√±') {
                e.preventDefault();
                generateTestText();
            }

            // Ctrl + Shift + √ë para activar auto-escritura
            if (e.ctrlKey && e.shiftKey && e.key === '√ë') {
                e.preventDefault();
                startAutoTyping();
            }
        });

        // Eventos
        userInputElement.addEventListener('input', handleInput);
        resetButton.addEventListener('click', fetchText);

        paragraphButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                paragraphButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedParagraphs = parseInt(btn.dataset.paragraphs);
                fetchText();
            });
        });

        sourceToggle.addEventListener('change', (e) => {
            useAI = e.target.checked;
            sourceLabel.textContent = useAI ? 'IA (Gratis)' : 'Wiki';
            fetchText();
        });

        starsToggle.addEventListener('change', (e) => {
            starsEnabled = e.target.checked;
            bgCanvas.classList.toggle('hidden', !starsEnabled);
            //starsLabel.textContent = starsEnabled ? 'Activado' : 'Desactivado';
        });

        // ---------------------------------------------------------
        // DISTRACTORES
        // ---------------------------------------------------------

        // Part√≠culas Flotantes
        class Particle {
            constructor() {
                this.x = Math.random() * window.innerWidth;
                this.y = Math.random() * window.innerHeight;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
                this.element = document.createElement('div');
                this.element.className = 'particle';
                this.element.style.backgroundColor = this.color;
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
                document.body.appendChild(this.element);
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                if (this.x < 0 || this.x > window.innerWidth) this.vx *= -1;
                if (this.y < 0 || this.y > window.innerHeight) this.vy *= -1;

                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
            }

            remove() {
                this.element.remove();
            }
        }

        function toggleParticles(enabled) {
            particlesEnabled = enabled;
            if (enabled) {
                for (let i = 0; i < 30; i++) {
                    particles.push(new Particle());
                }
            } else {
                particles.forEach(p => p.remove());
                particles = [];
            }
        }

        function animateParticles() {
            if (particlesEnabled) {
                particles.forEach(p => p.update());
            }
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        distractor2Toggle.addEventListener('change', (e) => {
            toggleParticles(e.target.checked);
        });

        // Efecto de Onda
        function initWave() {
            waveCtx = waveCanvas.getContext('2d');
            waveCanvas.width = window.innerWidth;
            waveCanvas.height = window.innerHeight;
        }

        function drawWave() {
            if (!waveEnabled) return;

            waveCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);

            // Cambiar estilo de onda cada 2 segundos
            const waveStyle = Math.floor(Date.now() / 2000) % 3;

            if (waveStyle === 0) {
                // Onda √∫nica gruesa
                waveCtx.strokeStyle = 'rgba(255, 0, 127, 0.4)';
                waveCtx.lineWidth = 5;
            } else if (waveStyle === 1) {
                // M√∫ltiples ondas delgadas
                waveCtx.strokeStyle = 'rgba(0, 255, 255, 0.3)';
                waveCtx.lineWidth = 2;
            } else {
                // Onda distorsionada
                waveCtx.strokeStyle = 'rgba(255, 255, 0, 0.35)';
                waveCtx.lineWidth = 4;
            }

            waveCtx.beginPath();

            for (let x = 0; x < waveCanvas.width; x += 3) {
                let y;
                if (waveStyle === 1) {
                    // M√∫ltiples ondas
                    y = waveY + Math.sin((x + waveOffset) * 0.02) * 30 + Math.sin((x + waveOffset * 2) * 0.05) * 15;
                } else if (waveStyle === 2) {
                    // Distorsi√≥n irregular
                    y = waveY + Math.sin((x + waveOffset) * 0.03) * 40 * (1 + Math.sin(waveOffset * 0.01) * 0.5);
                } else {
                    // Onda simple
                    y = waveY + Math.sin((x + waveOffset) * 0.025) * 50;
                }

                if (x === 0) waveCtx.moveTo(x, y);
                else waveCtx.lineTo(x, y);
            }

            waveCtx.stroke();

            // Mover la onda verticalmente
            waveY += waveDirection * 2;
            if (waveY > waveCanvas.height - 100 || waveY < 100) {
                waveDirection *= -1;
            }

            waveOffset += 3;

            requestAnimationFrame(drawWave);
        }

        distractor3Toggle.addEventListener('change', (e) => {
            waveEnabled = e.target.checked;
            waveCanvas.classList.toggle('active', waveEnabled);
            if (waveEnabled) {
                waveY = waveCanvas.height / 2;
                drawWave();
            }
        });

        // Lluvia de Emojis
        const animalEmojis = ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'üêÉ', 'üêÇ', 'üêÑ', 'ü¶ô', 'üêè', 'üêë', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêà', '‚ô•'];

        function createFallingEmoji() {
            const emoji = document.createElement('div');
            emoji.className = 'emoji-rain';
            emoji.textContent = animalEmojis[Math.floor(Math.random() * animalEmojis.length)];
            emoji.style.left = Math.random() * window.innerWidth + 'px';
            emoji.style.top = '-50px';
            document.body.appendChild(emoji);

            const duration = 3000 + Math.random() * 2000;
            const startTime = Date.now();

            function fall() {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / duration;

                if (progress < 1) {
                    emoji.style.top = (progress * window.innerHeight) + 'px';
                    requestAnimationFrame(fall);
                } else {
                    emoji.remove();
                }
            }
            fall();
        }

        function toggleEmojiRain(enabled) {
            emojiRainEnabled = enabled;
            if (enabled) {
                emojiInterval = setInterval(createFallingEmoji, 300);
            } else {
                clearInterval(emojiInterval);
                document.querySelectorAll('.emoji-rain').forEach(e => e.remove());
            }
        }

        distractor4Toggle.addEventListener('change', (e) => {
            toggleEmojiRain(e.target.checked);
        });

        // Tormenta (Lluvia + Truenos)
        class Raindrop {
            constructor() {
                this.x = Math.random() * window.innerWidth;
                this.y = -20;
                this.speed = 15 + Math.random() * 10;
                this.element = document.createElement('div');
                this.element.className = 'raindrop';
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
                document.body.appendChild(this.element);
            }

            update() {
                this.y += this.speed;
                this.element.style.top = this.y + 'px';

                if (this.y > window.innerHeight) {
                    this.remove();
                    return false;
                }
                return true;
            }

            remove() {
                this.element.remove();
            }
        }

        function createRain() {
            for (let i = 0; i < 50; i++) {
                raindrops.push(new Raindrop());
            }
        }

        function animateRain() {
            if (stormEnabled) {
                raindrops = raindrops.filter(drop => drop.update());
            }
            requestAnimationFrame(animateRain);
        }
        animateRain();

        function triggerThunder() {
            if (!stormEnabled) return;

            // Efecto visual de rel√°mpago
            thunderFlash.classList.add('active');

            // Sonido de trueno (usando Web Audio API)
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(30 + Math.random() * 70, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(30, audioContext.currentTime + 0.3);

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);

            setTimeout(() => {
                thunderFlash.classList.remove('active');
            }, 300);

            // Pr√≥ximo trueno en 3-8 segundos
            if (stormEnabled) {
                thunderInterval = setTimeout(triggerThunder, 3000 + Math.random() * 5000);
            }
        }

        function toggleStorm(enabled) {
            stormEnabled = enabled;
            rainOverlay.classList.toggle('active', enabled);

            if (enabled) {
                rainInterval = setInterval(createRain, 50);
                triggerThunder();
            } else {
                clearInterval(rainInterval);
                clearTimeout(thunderInterval);
                raindrops.forEach(drop => drop.remove());
                raindrops = [];
            }
        }

        distractor5Toggle.addEventListener('change', (e) => {
            toggleStorm(e.target.checked);
        });


        // 3D Background
        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: bgCanvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.position.z = 5;

            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(5000 * 3);
            for (let i = 0; i < 5000 * 3; i++) pos[i] = (Math.random() - 0.5) * 10;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            stars = new THREE.Points(geo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.02, transparent: true, opacity: 0.8 }));
            scene.add(stars);
        }
        function animate() {
            requestAnimationFrame(animate);
            if (starsEnabled && stars) {
                stars.rotation.y += rotationSpeed;
                stars.rotation.z += rotationSpeed * 0.5;
            }
            renderer.render(scene, camera);
        }
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

        window.onload = function () {
            initThreeJS();
            initWave();
            animate();
            fetchText();
        };
    </script>
</body>

</html>